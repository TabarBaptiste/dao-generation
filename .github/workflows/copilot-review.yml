name: Copilot Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            src/**/*.{ts,js,tsx,jsx}
            tests/**/*.{ts,js,tsx,jsx}

      - name: Code Quality Check
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
          
          # VÃ©rifications de qualitÃ© basiques
          echo "## ðŸ” Analyse de qualitÃ© automatique" >> $GITHUB_STEP_SUMMARY
          
          # Compte les lignes de code modifiÃ©es
          ADDED_LINES=$(git diff --numstat origin/main...HEAD | awk '{sum += $1} END {print sum}')
          REMOVED_LINES=$(git diff --numstat origin/main...HEAD | awk '{sum += $2} END {print sum}')
          
          echo "- âœ… Lignes ajoutÃ©es: $ADDED_LINES" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Lignes supprimÃ©es: $REMOVED_LINES" >> $GITHUB_STEP_SUMMARY
          
          # VÃ©rifie la prÃ©sence de console.log
          if git diff origin/${{ github.base_ref }}...HEAD | grep -E "console\.(log|debug|info|warn|error)"; then
            echo "- âš ï¸ Console.log dÃ©tectÃ©s - Ã  nettoyer avant merge" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… Pas de console.log dÃ©tectÃ©s" >> $GITHUB_STEP_SUMMARY
          fi
          
          # VÃ©rifie la prÃ©sence de types any
          if git diff origin/${{ github.base_ref }}...HEAD | grep -E ": any|any\[\]|any "; then
            echo "- âš ï¸ Types 'any' dÃ©tectÃ©s - privilÃ©gier des types spÃ©cifiques" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… Pas de types 'any' dÃ©tectÃ©s" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment PR
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8').slice(0, 5000);
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– Review automatique Copilot
              
              ${summary}

              ### ðŸ’¡ Suggestions d'optimisation Copilot
              - Assure-toi que les noms de variables/fonctions sont explicites
              - Ajoute des commentaires JSDoc pour guider Copilot
              - Utilise des types TypeScript prÃ©cis
              - Structure le code en fonctions courtes et focused

              *Cette review automatique aide Ã  maintenir la qualitÃ© du code pour optimiser les suggestions de Copilot.*`
            });